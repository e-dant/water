#!/usr/bin/env bash

LASTDIR="$PWD"
cd "$(dirname "$0")"
THISDIR="$PWD"
RETVAL=0
LLVM_VERSION=15

cc::init() {
  LLVM_DIR="$THISDIR/../../../tools/compilers/llvm"
  "$LLVM_DIR/tools/version/set" $LLVM_VERSION
  if test -z "$CC" || test -z "$CXX"
  then
    test -x "$LLVM_DIR/build/out/$LLVM_VERSION/bin/clang" \
      || "$LLVM_DIR/build/build"
    export CC="$LLVM_DIR/build/out/$LLVM_VERSION/bin/clang"
    export CXX="$LLVM_DIR/build/out/$LLVM_VERSION/bin/clang++"
  fi
}

cmake::build() {
  cmake \
    -D CMAKE_C_COMPILER="$CC" \
    -D CMAKE_CXX_COMPILER="$CXX" \
    -D LLVM_VERSION="$LLVM_VERSION" \
    -S 'in' -B 'out' -G 'Ninja' -Wno-dev \
    && cmake --build out --config Release
  RETVAL=$?
}

cc::init
cmake::build

cd "$LASTDIR"
exit $RETVAL
