#!/usr/bin/env bash

lastdir="$PWD"
cd "$(dirname "$0")"
thisdir="$PWD"
retval=0

cc::init() {
  $CC -v || {
    git submodule update --init --recursive;
    "$PWD/../../../tools/compilers/llvm/build/build";
    export CC="$PWD/../../../tools/compilers/llvm/build/out/13/bin/clang";
  }
  $CXX -v || {
    git submodule update --init --recursive;
    "$PWD/../../../tools/compilers/llvm/build/build";
    export CXX="$PWD/../../../tools/compilers/llvm/build/out/13/bin/clang";
  }
}

cmake::build() {
  cmake \
    -D CMAKE_C_COMPILER="$CC" \
    -D CMAKE_CXX_COMPILER="$CXX" \
    -S 'in' -B 'out' -G 'Ninja' -Wno-dev \
    && cmake --build out --config Release
  retval=$?
}

cc::init
cmake::build

cd "$lastdir"
exit $retval
